var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(i,o){function a(t){try{c(r.next(t))}catch(e){o(e)}}function s(t){try{c(r["throw"](t))}catch(e){o(e)}}function c(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(a,s)}c((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return r([t,e])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(a=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(o,n[1])).done)return a;switch(o=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(a=c.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){c.label=n[1];break}if(6===n[0]&&c.label<a[1]){c.label=a[1],a=n;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(n);break}a[2]&&c.ops.pop(),c.trys.pop();continue}n=e.call(t,c)}catch(r){n=[6,r],o=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},DragDisplayObject=function(){function t(t,e,n,r){void 0===e&&(e=null),void 0===n&&(n=null),void 0===r&&(r=null),this.center=!0,this.range=null,this.handle=null,this.distance=50,this.angle=0,this.obj=t,this.mouseup=e,this.mousedown=n,this.mousemove=r}return t}();__reflect(DragDisplayObject.prototype,"DragDisplayObject");var LaserPen=function(t){function e(e){var n=t.call(this)||this;return n._mirrors=[],n._rayLen=1e3,n._lines=[],n._stage=e,n._rayShape=new egret.Shape,n.addChild(n._rayShape),n.createPen(),n.createRayLine(),n.update(),n}return __extends(e,t),e.prototype.addMirror=function(t){this._mirrors.push(t),this.update()},e.prototype.createPen=function(){this._pen=this.createBitmapByName("pen_png"),this._pen.anchorOffsetX=this._pen.width/2,this._pen.anchorOffsetY=this._pen.height,this._pen.x=200,this._pen.y=200,this.addChild(this._pen),ObjectDecorator.get(this._pen).addDragAction(this._stage).upHandler(function(){}).moveHandler(function(){this.update()}.bind(this));var t=this.createBitmapByName("rotate_png");t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2,this.addChild(t),ObjectDecorator.get(this._pen).addRotateAction(this._stage,t,150,-90).moveHandler(function(){this.update()}.bind(this))},e.prototype.createRayLine=function(){this._rayLine=new RayLine},e.prototype.updateRayLine=function(){this._rayLine.startPoint.x=this._pen.x,this._rayLine.startPoint.y=this._pen.y,this._rayLine.direction=this._pen.rotation*Math.PI/180+Math.PI/2},e.prototype.update=function(){this._lines=[],this.updateRayLine(),this.hitTest(this._rayLine,this._mirrors,this._lines),this._mirrors[0]&&this._lines.push(this._mirrors[0]),console.log(this._lines),this.renderLines(this._lines)},e.prototype.hitTest=function(t,e,n){for(var r=[],i=0;i<e.length;i++){var o=t.hitLine(this._rayLen,e[i]);if(o){var a={cross:o,mirror:e[i]};r.push(a)}}if(0==r.length)return n.push({startPoint:t.startPoint,endPoint:t.getPoint(this._rayLen)}),n;for(var s=r[0],i=1;i<r.length;i++)this.getDistance(r[i].cross,t.startPoint)<this.getDistance(s.cross,t.startPoint)&&(s=r[i]);if(r=[],n.push({startPoint:t.startPoint,endPoint:s.cross}),s.mirror.reflect){var c=t.getReflexLine(this._rayLen,s.mirror);this.hitTest(c,e,n)}},e.prototype.renderLines=function(t){var e=this._rayShape.graphics;e.clear(),e.lineStyle(3,16711680);for(var n=0;n<t.length;n++)e.moveTo(t[n].startPoint.x,t[n].startPoint.y),e.lineTo(t[n].endPoint.x,t[n].endPoint.y)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e.prototype.getDistance=function(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},e}(egret.Sprite);__reflect(LaserPen.prototype,"LaserPen");var Line=function(){function t(){this._reflect=!0,this._startPoint=new egret.Point(0,0),this._endPoint=new egret.Point(10,100),this._reflect=!0}return Object.defineProperty(t.prototype,"startPoint",{get:function(){return this._startPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"endPoint",{get:function(){return this._endPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"reflect",{get:function(){return this._reflect},set:function(t){this._reflect=t},enumerable:!0,configurable:!0}),t.prototype.getRotation=function(){var t=this.startPoint,e=this.endPoint;return Math.atan2(e.y-t.y,e.x-t.x)},t}();__reflect(Line.prototype,"Line");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return[4,this.loadResource()];case 1:return n.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 2:return t=n.sent(),[4,platform.login()];case 3:return n.sent(),[4,platform.getUserInfo()];case 4:return e=n.sent(),console.log(e),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return n.sent(),this.stage.removeChild(t),[3,4];case 3:return e=n.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){var t=new LaserPen(this.stage);this.addChild(t);var e=new Mirror(this.stage);e.x=200,e.y=400,this.addChild(e),t.addMirror(e.line),e.addEventListener(Mirror.POSITION_CHANGE,function(){t.update()},this);var n=new Mirror(this.stage);n.x=600,n.y=500,this.addChild(n),t.addMirror(n.line),n.addEventListener(Mirror.POSITION_CHANGE,function(){t.update()},this)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Mirror=function(t){function e(e){var n=t.call(this)||this;return n._mirrorLength=200,n._stage=e,n._line=new Line,n.drawMirror(),n.updateLine(),n}return __extends(e,t),Object.defineProperty(e.prototype,"line",{get:function(){return this._line},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{set:function(t){this._mirror.x=t,ObjectDecorator.get(this._mirror).updateRotateHandlePosition()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{set:function(t){this._mirror.y=t,ObjectDecorator.get(this._mirror).updateRotateHandlePosition()},enumerable:!0,configurable:!0}),e.prototype.drawMirror=function(){this._mirror=this.createBitmapByName("mirror_png"),this._mirror.anchorOffsetX=this._mirror.width/2,this.addChild(this._mirror);var t=this.createBitmapByName("rotate_png");t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2,this.addChild(t),ObjectDecorator.get(this._mirror).addRotateAction(this._stage,t,150,0).moveHandler(function(){this.updateLine(),this.dispatchEvent(new egret.Event(e.POSITION_CHANGE))}.bind(this)),ObjectDecorator.get(this._mirror).addDragAction(this._stage).moveHandler(function(){this.updateLine(),this.dispatchEvent(new egret.Event(e.POSITION_CHANGE))}.bind(this))},e.prototype.updateLine=function(){var t=this._mirror.rotation*Math.PI/180,e=this._mirrorLength/2*Math.cos(t),n=this._mirrorLength/2*Math.sin(t);this.line.startPoint.x=this._mirror.x-e,this.line.startPoint.y=this._mirror.y-n,this.line.endPoint.x=this._mirror.x+e,this.line.endPoint.y=this._mirror.y+n},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e.POSITION_CHANGE="position_change",e}(egret.Sprite);__reflect(Mirror.prototype,"Mirror");var ObjectDecorator=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.get=function(t){return e.currentObj=e.objs.filter(function(e,n,r){return e.obj==t?!0:void 0})[0],e.currentObj||(e.currentObj=new DragDisplayObject(t),e.objs.push(e.currentObj)),e},e.addDragAction=function(t,n,r){return void 0===n&&(n=null),void 0===r&&(r=!1),e.currentObj.obj.touchEnabled=!0,e.currentObj.range=n,e.currentObj.center=r,e.currentObj.obj.addEventListener(egret.TouchEvent.TOUCH_BEGIN,e.dragBeginHandler,this),e.stage=t,e},e.addRotateAction=function(t,n,r,i){return void 0===r&&(r=20),void 0===i&&(i=0),e.currentObj.handle=n,e.currentObj.distance=r,e.currentObj.angle=i,e.updateRotateHandlePosition(),n.touchEnabled=!0,e.currentObj.handle.addEventListener(egret.TouchEvent.TOUCH_BEGIN,e.rotateBeginHandler,this),e},e.upHandler=function(t){return e.currentObj.mouseup=t,e},e.moveHandler=function(t){return e.currentObj.mousemove=t,e},e.downHandler=function(t){return e.currentObj.mousedown=t,e},e.dragBeginHandler=function(t){var n=t.currentTarget;e.currentObj=e.objs.filter(function(t,e,r){return t.obj==n?!0:void 0})[0],e.isDraging=!0,e.currentObj.center?(e.offsetX=0,e.offsetY=0):(e.offsetX=t.stageX-n.x,e.offsetY=t.stageY-n.y),e.stage.hasEventListener(egret.TouchEvent.TOUCH_MOVE)||e.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this),e.stage.hasEventListener(egret.TouchEvent.TOUCH_END)||e.stage.addEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.currentObj.mousedown instanceof Function&&e.currentObj.mousedown()},e.rotateBeginHandler=function(t){var n=t.currentTarget;e.currentObj=e.objs.filter(function(t,e,r){return t.handle==n?!0:void 0})[0],e.isRotating=!0,e.stage.hasEventListener(egret.TouchEvent.TOUCH_MOVE)||e.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this),e.stage.hasEventListener(egret.TouchEvent.TOUCH_END)||e.stage.addEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.currentObj.mousedown instanceof Function&&e.currentObj.mousedown()},e.stageTouchMoveHandler=function(t){if(null!=e.currentObj){if(e.isDraging){var n=t.stageX-e.offsetX,r=t.stageY-e.offsetY,i=e.currentObj.range;i instanceof egret.Rectangle&&(n=Math.min(Math.max(n,i.x),i.x+i.width),r=Math.min(Math.max(r,i.y),i.y+i.height)),e.currentObj.obj.x=n,e.currentObj.obj.y=r,e.updateRotateHandlePosition()}if(e.isRotating){e.currentObj.handle.x=t.stageX,e.currentObj.handle.y=t.stageY;var o=t.stageX-e.currentObj.obj.x,a=t.stageY-e.currentObj.obj.y,s=180*Math.atan2(a,o)/Math.PI;e.currentObj.obj.rotation=s-e.currentObj.angle}e.currentObj.mousemove instanceof Function&&e.currentObj.mousemove()}},e.stageTouchEndHandler=function(t){e.currentObj.mouseup instanceof Function&&e.currentObj.mouseup(),e.updateRotateHandlePosition(),e.isRotating=!1,e.isDraging=!1,e.currentObj=null,e.stage.removeEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this)},e.updateRotateHandlePosition=function(){if(null!=e.currentObj.handle){var t=e.currentObj.distance,n=e.currentObj.angle+e.currentObj.obj.rotation,r=n*Math.PI/180,i=Math.cos(r)*t,o=Math.sin(r)*t;e.currentObj.handle.x=e.currentObj.obj.x+i,e.currentObj.handle.y=e.currentObj.obj.y+o}},e.objs=[],e.isRotating=!1,e.isDraging=!1,e}(egret.DisplayObject);__reflect(ObjectDecorator.prototype,"ObjectDecorator");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var RayLine=function(){function t(){this._startPoint=new egret.Point(0,0),this._direction=0}return Object.defineProperty(t.prototype,"startPoint",{get:function(){return this._startPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(t){this._direction=t},enumerable:!0,configurable:!0}),t.prototype.getPoint=function(t){var e=t*Math.cos(this._direction),n=t*Math.sin(this._direction);return new egret.Point(this._startPoint.x+e,this._startPoint.y+n)},t.prototype.hitLine=function(t,e){var n,r=this._startPoint,i=this.getPoint(t),o=e.startPoint,a=e.endPoint;if(n=this.segmentsIntr(r,i,o,a)){var s=this.getDistance(r,n);if(3>s)return null}return n},t.prototype.getReflexLine=function(e,n){var r;if(r=this.hitLine(e,n)){var i=n.getRotation(),o=new t;return o._startPoint=r,o._direction=2*i-this._direction,o}return null},t.prototype.segmentsIntr=function(t,e,n,r){var i=(e.y-t.y)*(r.x-n.x)-(t.x-e.x)*(n.y-r.y);if(0==i)return null;var o=((e.x-t.x)*(r.x-n.x)*(n.y-t.y)+(e.y-t.y)*(r.x-n.x)*t.x-(r.y-n.y)*(e.x-t.x)*n.x)/i,a=-((e.y-t.y)*(r.y-n.y)*(n.x-t.x)+(e.x-t.x)*(r.y-n.y)*t.y-(r.x-n.x)*(e.y-t.y)*n.y)/i;return console.log((a-t.y)*(a-e.y)),Math.round(o-t.x)*Math.round(o-e.x)<=0&&Math.round(a-t.y)*Math.round(a-e.y)<=0&&Math.round(o-n.x)*Math.round(o-r.x)<=0&&Math.round(a-n.y)*Math.round(a-r.y)<=0?new egret.Point(o,a):null},t.prototype.getDistance=function(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},t}();__reflect(RayLine.prototype,"RayLine");